<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2155106 염성현 성적 관리 사이트</title>
    <script src="https://code.jquery.com/jquery-3.6.4.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-3.4.1.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- part1 로그인 및 회원 가입 화면 -->
    <div id="part1">
        <h1>성적 관리 사이트</h1>
        <button id="showLoginSection">로그인 하러가기</button>
        <button id="showRegisterSection">회원가입 하러가기</button>

        <!-- 로그인 화면 -->
        <div id="loginSection" style="display: none;">
            <h2>로그인</h2>
            <input type="text" id="login_id" placeholder="아이디를 입력하세요.">
            <input type="password" id="login_password" placeholder="비밀번호를 입력하세요">
            <button id="login">로그인</button>
        </div>

        <!-- 회원가입 화면 -->
        <div id="registerSection" style="display: none;">
            <h2>회원 가입</h2>
            <input type="text" id="register_id" placeholder="아이디를 입력하세요.">
            <input type="password" id="register_password" placeholder="비밀번호를 입력하세요">
            <input type="text" id="register_name" placeholder="이름을 입력하세요">
            <button id="register">회원가입</button>
        </div>
    </div>

    <!-- part2 관리자 화면 -->

    <div id="part2" style="display: none;">
        <!--유저 회원 리스트 관리 [모든 유저 아이디 검색]-->
        <h2></h2>
        <button class="logout">로그아웃</button><br>
        <div id="user_list">
            <h3>유저 정보</h3>
            <select id="user_select">
                <option value="회원 선택">유저 선택</option>
            </select>
            <div id="selected_user_info"></div>
            <button id="selected_user_delete" style="display: none;">회원 삭제</button>
            <button id="selected_user_update" style="display: none;">비밀번호 강제 변경</button>

        </div>
        <!-- 커스텀 과목 및 해당 과목에 대한 학점 추가-->
        <div id="subject">
            <h3>과목 추가</h3>
            <!-- 학과 선택 박스 만들어야함 -->
            
            
            <select class="dept_list">
                <option value="학과 선택">학과 선택</option>
            </select>

            <input type="text" id="input_subject" placeholder="추가할 과목 입력">
            <input type="text" id="input_credits" placeholder="해당 과목에 대한 학점">

            <button id="remove_dept">선택 학과 삭제</button>
            <button id="add_subject">입력 과목 추가</button>

            <input type="text" id="input_dept" placeholder="추가할 학과 입력">
            <button id="add_dept">입력 학과 추가</button>

            <h3>설정된 과목 리스트</h3>
            <div id="subject_list"></div>
            <br>
        </div>

        <div id="score">

            <select class="dept_list">
                <option value="학과 선택">학과 선택</option>
            </select>
            <select class="subject_list">
                <option value="과목 선택">과목 선택</option>
            </select>
            <select class="user_list">
                <option value="회원 선택">유저 선택</option>
            </select>
            <input type="text" id ="input_scores" placeholder="성적(백분율)을 입력하세요.">
            <button id="set_scores">성적 설정</button>
        </div>
        



    </div>

    <!-- part3 일반 사용자 화면 -->
    <div id="part3" style="display: none;">
        <h2></h2>
        <br><button class="logout">로그아웃</button></br>
    </div>

    <script>
        $(function () {
            /** part1 **/
            //아이디 및 비밀번호 저장
            var usersList = {
                admin: 'admin',
                momo2413: 'momo2413'
            }
            //이름 저장
            var usersName = {
                admin: '관리자',
                momo2413: '성현'
            }

            //로그인 횟수 저장
            var usersLoginCount = {
                admin: 0,
                momo2413: 0
            }

            //최근 로그인 날짜
            var usersLoginDate = {
                admin: new Date(),
                momo2413: new Date()
            }
            
            //과목,학점
            var subjectList = {
                '컴퓨터공학과': {
                    '프로그래밍언어론': 3,
                    '데이터베이스': 2
                }
            };



            //로그인 하러가기
            var showLoginHandler = function () {
                $('#registerSection').hide();
                $('#loginSection').show();
            }

            //회원가입 하러가기
            var showRegisterHandler = function () {
                $('#loginSection').hide();
                $('#registerSection').show();
            }


            //아이디 체크 (영문자 또는 영문 숫자 3~20자)
            function isId(id) {
                var regExp = /^[0-9a-zA-Z]{3,20}$/;

                return regExp.test(id);
            }

            //비밀번호 체크 (5 ~ 16자 영문 또는 영문 숫자 조합)
            function isPassword(password) {
                var regExp = /^[0-9a-zA-Z]{5,16}$/;

                return regExp.test(password);
            }

            //이름 체크 (한글,영문)
            function isName(name) {
                var regExp = /^[a-zA-Zㄱ-힣][a-zA-Zㄱ-힣 ]*$/;

                return regExp.test(name);
            }

            // 유효성 검사 함수
            function validateInput(id, password, name) {
                if (id == '' || password == '') {
                    alert('아이디 또는 비밀번호를 입력해주세요.');
                    $(id).focus();
                    return false;
                }
                else if (!isId(id)) {
                    alert('아이디는 영문자 또는 숫자 3 ~ 20자를 입력해주세요.');
                    $(id).val('');
                    $(password).val('');
                    $(id).focus();
                    return false;
                }
                else if (!isPassword(password)) {
                    alert('비밀번호는 5 ~ 16자 영문 또는 영문과 숫자를 조합해야합니다.');
                    $(id).val('');
                    $(password).val('');
                    $(password).focus();
                    return false;
                }
                else if (name && !isName(name)) {
                    alert('이름은 반드시 한글 또는 영어로 작성해야합니다.');
                    return false;
                }

                return true;
            }

            //로그아웃 이벤트 
            var logoutHandler = function () {
                $('#part2').hide();
                $('#part3').hide();
                $('#part1').show();
            }

            //로그인 시 로그아웃 버튼, 환영 문구 추가
            var successLogin = function (partNum, id) {
                $(`#part${partNum} h2`).text(usersName[id] + '님 어서오세요!')
                $(`.logout`).on('click', logoutHandler)

                // 관리자로 로그인한 경우 유저 정보 출력
                if (id === 'admin') {
                    viewUserList();
                }
            }
            // 날짜 포맷팅 함수
            function formatDate(date) {
                var year = date.getFullYear();
                var month = String(date.getMonth() + 1).padStart(2, '0');
                var day = String(date.getDate()).padStart(2, '0');
                var hours = String(date.getHours()).padStart(2, '0');
                var minutes = String(date.getMinutes()).padStart(2, '0');

                return `${year}/${month}/${day} ${hours}:${minutes}`;
            }

            //선택한 회원 유저
            var selectedUser;
            //선택한 학과
            var selectedDept;

            //관리자 페이지 : 유저 정보
            var userSelectHandler = function () {
                selectedUser = $('#user_select').val();

                if (selectedUser) {
                    var userInfo = `<br>아이디: ${selectedUser}, 비밀번호: ${usersList[selectedUser]} 이름: ${usersName[selectedUser]},
                     로그인 횟수: ${usersLoginCount[selectedUser]}, 로그인 시간: ${formatDate(usersLoginDate[selectedUser])} </br>`;
                    $('#selected_user_info').html(userInfo);
                    //선택박스 선택 시 버튼 활성화
                    $('#selected_user_delete').show();
                    $('#selected_user_update').show();

                } else {
                    $('#selected_user_info').empty();
                }
            }
            //유저 정보 출력 
            var viewUserList = function () {
                $('#user_select').empty();
                $('#checkbox_list').empty(); //checkBox 리스트 초기화
                for (var user in usersName) {
                    $('#user_select').append('<option value="' + user + '">' + '이름: ' + usersName[user] + ' (아이디: ' + user + ')</option>');
                }
                $('#selected_user_info').html('');
            }


            //회원 삭제 이벤트 핸들러
            var userDeleteHandler = function () {
                var isDelete = confirm('정말 삭제하시겠습니까?');
                if (isDelete) {
                    if (selectedUser === 'admin') {
                        alert('관리자는 삭제될 수 없습니다.');
                        return;
                    }
                    delete usersList[selectedUser];
                    delete usersName[selectedUser];
                    alert(`${selectedUser} 아이디를 성공적으로 삭제하였습니다.`);
                    //삭제 후 갱신
                    viewUserList();
                    $('#user_select').prop('selectedIndex', 0);
                    selectedUser = $('#user_select option:first').val();
                    $('#selected_user_info').html('');
                } else alert('취소하셨습니다.');
            }

            //회원 비밀번호 강제 변경 이벤트 핸들러
            var userUpdateHandler = function () {
                var update_password = prompt("강제로 변경할 비밀번호를 입력해주세요");
                if (update_password == null) return;
                var isUpdate = confirm(`${selectedUser} 아이디를 ${update_password} 비밀번호로 강제 변경하시겠습니까?`);
                
                if (isUpdate) {
                    if (selectedUser === 'admin') {
                        alert('관리자 비밀번호는 변경할 수 없습니다.');
                        return;
                    }
                    if (validateInput(selectedUser, update_password)) {
                        //비밀번호 변경
                        usersList[selectedUser] = update_password;
                        alert('성공적으로 변경하셨습니다.');
                    }
                }
            }

            // 학과 추가 기능 핸들러 (버튼)
            var addDeptHandler = function () {
                var dept = $('#input_dept').val();

                if (dept && !subjectList[dept]) {
                    //학과 deptList 객체에 추가
                    subjectList[dept] = {};
                    alert('학과가 추가되었습니다.');
                    $('#input_dept').val('');
                    //업데이트 체크박스
                    deptUpdateHandler();
                }
                else if (subjectList.hasOwnProperty(dept)) {
                    alert('이미 존재하는 학과입니다.');
                } else {
                    alert('학과를 입력해주세요.');
                }
                };
            //학과 삭제 기능 핸들러 

            var removeDeptHandler = function() {
                var dept =  $('.dept_list').val();
                var isDelete = confirm(`정말 ${dept} 학과를 삭제하시겠습니까?`);
                if (isDelete) {
                    delete subjectList[dept];
                    deptUpdateHandler();
                    displaySubjectList();
                    alert(`${dept} 학과를 성공적으로 삭제하였습니다`);
                }
                else alert('취소하셨습니다.');
            }
            
            //선택한 학과 체크박스


            //학과 체크박스 업데이트
            var deptUpdateHandler = function() {
                
                var deptList = $('.dept_list');
                deptList.empty(); //checkBox 리스트 초기화
                for (var dept in subjectList) {
                    deptList.append(`<option value='${dept}'>${dept}</option>`);
                }
            }
            
            //학과 추가 이벤트 핸들러
            $('#add_dept').on('click', addDeptHandler);
            $('#remove_dept').on('click', removeDeptHandler);
            // 과목 추가 이벤트 핸들러
            var addSubjectHandler = function () {
                var dept = $('.dept_list').val();
                var subject = $('#input_subject').val();
                var credits = $('#input_credits').val();

                if(isNaN(credits)) alert('학점에는 숫자만 입력해주세요');

                if (dept && subject && credits) {
                    subjectList[dept][subject] = parseInt(credits);
                    $('#input_subject').val('');
                    $('#input_credits').val('');
                    displaySubjectList();
                } else {
                    alert('과목과 학점을 모두 입력해주세요.');
                }
            }

            // 과목 삭제 이벤트 핸들러
            var removeSubjectHandler = function (dept, subject) {
                var isRemove = confirm(`'${subject}' 과목을 삭제하시겠습니까?`);
                if (isRemove) {
                    //해당 학과에서 과목 삭제
                    delete subjectList[dept][subject];
                    displaySubjectList();
                }
            }

            // 설정된 과목 리스트 출력
            var displaySubjectList = function () {
            var subjectListHTML = '';
            for (var dept in subjectList) {
                for (var subject in subjectList[dept]) {
                    var credits = subjectList[dept][subject];
                subjectListHTML += `<p>${dept} ${subject} (${credits}학점) <span class="remove" data-dept="${dept}" data-subject="${subject}">X</span></p>`;
                }
                $('#subject_list').html(subjectListHTML);
            }
        };


            //로그인 구현
            var loginHandler = function () {
                var id = $('#login_id').val();
                var password = $('#login_password').val();

                // 유효성 검사
                if (!validateInput(id, password)) {
                    return;
                }
                //로그인 성공 
                else if (usersList[id] && usersList[id] === password) {
                    $('#login_id').val('');
                    $('#login_password').val('');
                    $('#part1').hide();
                    if (id == 'admin') {
                        $('#part2').show();
                        alert('로그인 성공: 관리자 페이지로 접속하셨습니다.');
                        //로그인 횟수
                        usersLoginCount[id] = ++usersLoginCount[id];
                        //최근 로그인 날짜
                        usersLoginDate[id] = new Date();
                        successLogin(2, id);

                        // 초기 과목 리스트 출력
                        displaySubjectList();

                        // 초기 학과 리스트 출력
                        deptUpdateHandler();


                    }
                    else {
                        $('#part3').show();
                        alert(`로그인 성공: ${usersName[id]}님 어서오세요! 자신의 학점을 확인할 수 있습니다.`);
                        usersLoginCount[id] = ++usersLoginCount[id];
                        //최근 로그인 날짜
                        usersLoginDate[id] = new Date();
                        successLogin(3, id);
                    }
                }
                else alert("아이디가 존재하지 않거나, 아이디 또는 비밀번호가 틀립니다.");
            }


            //회원가입 구현
            var registerHandler = function () {
                var id = $('#register_id').val();
                var password = $('#register_password').val();
                var name = $('#register_name').val();

                // 유효성 검사
                if (!validateInput(id, password, name)) {
                    return;
                }

                //회원가입 성공
                else if (!usersList[id]) {
                    usersList[id] = password;
                    usersName[id] = name;
                    usersLoginCount[id] = 0;
                    usersLoginDate[id] = new Date();
                    alert(`${usersName[id]}님 환영합니다. 회원가입에 성공하셨습니다! 로그인 해주세요!`);
                    $('#registerSection').hide();
                    $('#loginSection').show();
                    $('#register_id').val('');
                    $('#register_password').val('');
                    $('#register_name').val('');

                } else {
                    alert('이미 존재하는 아이디입니다.');
                }

            }



            /** part2 
             1. 선택한 유저 정보 출력 
             2. 선택한 유저 회원 삭제
             3. 선택한 유저 비밀번호 강제 변경 (input 칸 2개 (다시 입력) 로 입력)
             4. 과목 추가 (이름, 학점)
             5. 과목 목록
             6. 선택한 유저 - 과목 선택 - 점수 입력 - 추가,업데이트,삭제**/



            //이벤트 핸들러 등록
            $('#showLoginSection').on('click', showLoginHandler)
            $('#showRegisterSection').on('click', showRegisterHandler)
            $('#login').on('click', loginHandler)
            $('#register').on('click', registerHandler)
            $('#user_select').on('change', userSelectHandler);
            $('#selected_user_delete').on('click', userDeleteHandler);
            $('#selected_user_update').on('click', userUpdateHandler);
            $('#add_subject').on('click', addSubjectHandler);

            //과목 삭제 이벤트 
            $(document).on('click', '.remove', function () {
                var dept = $(this).data('dept');
                var subject = $(this).data('subject');
                removeSubjectHandler(dept, subject);
            });
        });
    </script>
</body>


</html>